<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Report</title>
  <!-- links css -->
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-duotone-thin.css">
  <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/sharp-duotone-solid.css">
  <!-- font 1 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playwrite+RO:wght@100..400&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <!-- font 2 -->
  <link href="https://fonts.cdnfonts.com/css/sf-pro-display" rel="stylesheet">
  <!-- pdf js. -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <!-- firebase Script -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  
  <style> 
    @import url('https://fonts.cdnfonts.com/css/sf-pro-display');     
    :root {
      --bg-color: #f9f9f9;
      --text-color: #111;
      --card-bg: #fff;
      --button-bg: #007aff;
      --modal-bg: #ffffff;
      --transparent-bg: #ffffff81;
      --search: #00000027;
      --pink: #2b58ff5d;
      --bt-textclr: #0057ff;
      --toast-dark: #13e44511;
      --border: #11c7bf;
      --dash-svg: #7027e9;
      --dash-bg: #e9e9e9;
    }
    .dark-mode {
      --bg-color: #1e1e1e;
      --text-color: #eee;
      --card-bg: #2b2b2b;
      --button-bg: #007aff;
      --modal-bg: #2b2b2b;
      --transparent-bg: #00000081;
      --search: #ffffff27;
      --bt-textclr: #d995ff;
      --toast-dark: #fffff;
      --border: #0a736e;
      --dash-svg: #f4bf00;
      --dash-bg: #4f4f4f;
      }
<!-- Tap Highlight -->
button, input, textarea {
  outline: none;
  box-shadow: none;
}
<!-- scroll bar -->

body::-webkit-scrollbar {
  display: none; /* Chrome/Safari */
}

.fa-heart, footer h1 {
  background: linear-gradient(to right, #ff0088aa, #feb47b); /* Adjust colors */
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

* {
  font-family: 'SF Pro Display', sans-serif;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  transition: .5s ease;
  -webkit-tap-highlight-color: none;
  -webkit-focus-ring-color: none;
  outline: none;
}
.head{
    padding: 15px 10px;
    position: sticky;
    width: 100%;
    height: 150px;
    background: var(--transparent-bg);
    backdrop-filter: blur(17px);
    top: 0;
    left: 0;
    z-index: 999;
}
.stats {
  display: block;
  gap: 0rem;
  border-radius: 0px;
  margin-bottom: 1.5rem;
  padding: 7px;
  background: var(--card-bg);
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  position: sticky;
  top: 40px; /* below header */
  z-index: 998;
}
.card {
  padding: 8px;
  display: flex;
}

body {
  background-color: var(--bg-color);
  color: var(--text-color);
  scrollbar-width: none;
  -ms-overflow-style: none;
  max-width: 800px;
  margin: 0 auto;
}

#menu-toggle i {
  padding: 0px 6px;
  color: #0081ff;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  color: #0081ff;
}

header h1 {
  font-size: 1.25rem;
  font-weight: 600;
}

.controls {
  
  color: var(--text-color);
  flex-direction: column;
  gap: 0rem;
  margin-bottom: 1rem;
  backdrop-filter: blur(70px);
  background: var(--search);
  width: 100%;
  border-radius: 18px;
  padding: 8px 15px;"
  font-size: 14px;
  line-height: 1px;
  border: 0px solid #45454582;
}

.controls input[type="text"] {
  border: none;
  font-size: 15px;
  background: none;
  outline: none;
  width: 80%;
  color: var(--text-color);
}
.controls i{
    width: 5%;
}
.controls button,
.modal-content button.save,
#manual-search {
  padding: 0.75rem;
  background-color: var(--button-bg);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 15px;
  cursor: pointer;
}

.table-container {
  overflow-x: auto;
  padding: 10px 10px;
}
.thead{
    background: var(--bg-color);
}
thead.thead th {
  position: sticky;
  top: 0; /* head (150px) + stats (60px estimated with margin) */
  background: var(--card-bg);
  z-index: 997;
  border-radius: 5px;
}
table {
  width: 100%;
  border-collapse: collapse;
  background: var(--card-bg);
  min-width: 600px;
  border-radius: 5px;
  box-shadow: 0px 0px 10px #898989d1;
  
}
th{
    text-align: center;
    border-bottom: 2px solid var(--border);
}
th, td {
  padding: .7rem;
  border-top: 1px solid #ccc;
}

.modal {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.35); /* slightly lighter */
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(4px); /* smoother blur */
}

.modal-content {
  background: var(--modal-bg);
  padding: 1rem;
  border-radius: 16px;
  width: 80%;
  max-width: 400px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.modal-content p{
    padding: 5px 0px 15px 0px;
}
.modal-content input {
  width: 100%;
  margin-bottom: 1rem;
  padding: 0.75rem;
  border: 1px solid #ccc;
  border-radius: 10px;
  font-size: 15px;
  background: none;
  color: var(--text-color);
}

.product-row {
  display: flex;
  gap: 0.5rem;
}

.modal-content button.delete {
  background-color: #ff3b30;
  color: white;
  border: none;
  outline: none;
  border-radius: 15px;
  padding: 8px 10px;
}

#reader-wrapper {
  display: none;
  flex-direction: column;
  align-items: center;
  margin-top: 1rem;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  z-index: 9999;
  justify-content: center;
}

#reader {
  width: 100%;
  max-width: 300px;
}

#close-scan {
  margin-top: 0.5rem;
  background: #ccc;
  border-radius: 6px;
  padding: 0.5rem 1rem;
  border: none;
  cursor: pointer;
}
.scan{
    background: #006cff;
    outline: none; 
    border: none; 
    border-radius: 10px;
    padding: 0px 15px;
    height: 42px;
    color: white;
    font-weight: bold;
}
@media (max-width: 600px) {
  .stats {
    flex-direction: column;
  }
  .controls {
    flex-direction: column;
  }
  .modal-content {
    width: 95%;
  }
}

#AddButton {
  background: none;
  font-size: 20px;
  border: none;
  outline: none;
  padding: 0px 20px;
  color: #0081ff;
}

.icon-img{
    height: 32px;
    width: 32px;
    border-radius: 6px;
}
.card section{
    padding: 0px 8px;
}
footer h1{
    font-size: 60px;
    padding: 1ppx;
    color: var(--pink);
    font-family: "Playwrite RO", cursive;
    font-size: 70px;
    text-align: center;
}
footer p{
    color: var(--bt-textclr);
    font-family: "Playwrite RO", cursive;
    font-size: 15px;
    text-align: center;
    padding-top: 20px;
}

::-webkit-scrollbar {
  width: 0;
  height: 0;
}
.Back-to-lead{
    font-size: 12px;
    padding: 1px 5px 14px 5px;
    color: #006cff;
    }
.fa-triangle{
    transform: rotate(-90deg);
}
a, a:visited, a:hover, a:active {
    color: inherit;
    text-decoration: none;
}
@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
.editSale{
    background: none;
    color: #ff152a;
    outline: none; border: none;
}
.dasIcon {
  background: var(--dash-bg);
  border-radius: 6px;
  height: 38px;
  width: 38px;
  display: flex;              /* ✅ Flexbox for centering */
  align-items: center;        /* ✅ Vertical center */
  justify-content: center;    /* ✅ Horizontal center */
}

.dasIcon svg {
  height: 20px;
  fill: var(--dash-svg);
}
  </style>
</head>
<body>
    <div class="head">
        <div class="Back-to-lead">
            <a href="index.html">
              <p><i class="fas fa-triangle"></i> Back to Lead X</p>
            </a>
        </div>
  <header>
  <button id="menu-toggle" style="background: none; border: none; font-size: 24px; cursor: pointer; display: flex;">
      <i class="fa-solid fa-chevron-left" style="margin-top: 3px;"></i>
      <img id="profile-pic" src="" alt="Profile" style="width: 30px; height: 30px; border-radius: 50%;"/>
  </button>
  <p style="font-size: 18px;line-height: 28px;"><strong>Sale Report</strong></p>
 
  <nav id="nav-menu" style="display:none; position:absolute; top:80px; left: 14px;; background:white; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); z-index:10001; min-width: 160px;">
    <ul style="list-style:none; padding:10px; margin:0;">
      <li><label style="display:flex; align-items:center; gap:8px;">
        <input type="checkbox" id="theme-toggle"> Dark Mode
      </label></li>
      <li><button onclick="openExportModal()" style="margin-top: 10px; width: 100%; padding: 8px; background:#007aff; color:white; border:none; border-radius:6px;">Export</button></li>
      <a href="mailto:sanjeevoberoi@proton.me?subject=Support%20for%20LeadX%20%F0%9F%91%8B%F0%9F%8F%BB&body=Need%20support%20for%20LeadX">
        <li><button onclick="" style="margin-top: 5px; width: 100%; padding: 8px; background:#007aff; color:white; border:none; border-radius:6px;">support</li></a>
        <li><button onclick="confirmResetSales()" style="margin-top: 5px; width: 100%; padding: 8px; background:#ff3b30; color:white; border:none; border-radius:6px;">Reset Sales</button></li>
    </ul>
  </nav>
  <button onclick="openModal()" id="AddButton" style="color: #0081ff;">
      <i class="far fa-add"></i>
      
  </button>
</header>
<div class="controls">
    <i class="fas fa-search"></i>
    <input type="text" id="search-input" placeholder="Search Sale..." oninput="filterSales()">
  </div>
  </div>
  <div class="stats">
      
    <div class="card">
        <section class="dasIcon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M0 24C0 10.7 10.7 0 24 0L69.5 0c22 0 41.5 12.8 50.6 32l411 0c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3l-288.5 0 5.4 28.5c2.2 11.3 12.1 19.5 23.6 19.5L488 336c13.3 0 24 10.7 24 24s-10.7 24-24 24l-288.3 0c-34.6 0-64.3-24.6-70.7-58.5L77.4 54.5c-.7-3.8-4-6.5-7.9-6.5L24 48C10.7 48 0 37.3 0 24zM128 464a48 48 0 1 1 96 0 48 48 0 1 1 -96 0zm336-48a48 48 0 1 1 0 96 48 48 0 1 1 0-96z"/></svg>
       </section>
       <section>
         <div>Total Bills</div>
         <strong id="total-count">0</strong>
      </section>
    </div>
    <div class="card">
      <section class="dasIcon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M160 80c0-26.5 21.5-48 48-48l32 0c26.5 0 48 21.5 48 48l0 352c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48l0-352zM0 272c0-26.5 21.5-48 48-48l32 0c26.5 0 48 21.5 48 48l0 160c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48L0 272zM368 96l32 0c26.5 0 48 21.5 48 48l0 288c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48z"/></svg>
      </section>
      <section>
        <div>Total Sale amount</div>
        <strong id="total-value">0</strong>
      </section>
    </div>
    <div class="card">
      <section class="dasIcon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.--><path d="M384 312.7c-55.1 136.7-187.1 54-187.1 54-40.5 81.8-107.4 134.4-184.6 134.7-16.1 0-16.6-24.4 0-24.4 64.4-.3 120.5-42.7 157.2-110.1-41.1 15.9-118.6 27.9-161.6-82.2 109-44.9 159.1 11.2 178.3 45.5 9.9-24.4 17-50.9 21.6-79.7 0 0-139.7 21.9-149.5-98.1 119.1-47.9 152.6 76.7 152.6 76.7 1.6-16.7 3.3-52.6 3.3-53.4 0 0-106.3-73.7-38.1-165.2 124.6 43 61.4 162.4 61.4 162.4 .5 1.6 .5 23.8 0 33.4 0 0 45.2-89 136.4-57.5-4.2 134-141.9 106.4-141.9 106.4-4.4 27.4-11.2 53.4-20 77.5 0 0 83-91.8 172-20z"/></svg>
      </section>
      <section>
        <div>ResQ Sale</div>
        <strong id="rcp-count">0</strong>
      </section>
    </div>
  </div>  
  
  <div class="table-container">
    <table>
      <thead class="thead">
        <tr class="tr">
          <th>Name</th>
          <th>Phone</th>
          <th>Product</th>
          <th>Sale</th>
          <th>RCP</th>
        </tr>
      </thead>
      <tbody id="sales-body">
       
      </tbody>
    </table>
  </div>  
  <div class="modal" id="saleModal">
    <div class="modal-content">
      <section style="padding:0px 0px 20px 0px;" onclick="CloseModalEnd()"><i class="fas fa-circle-xmark"></i><span> Close</span></section>
      <input type="text" id="name" placeholder="Name">
      <input type="text" id="phone" placeholder="Phone" oninput="validateNumberInput(this, 13)">
      <div class="product-row">
        <input type="text" id="product" placeholder="Product">
        <button type="button" class="scan" onclick="startScan()">Scan</button>
      </div>
      <input type="text" id="sale" placeholder="Sale" oninput="validateNumberInput(this)">
      <input type="text" id="rcp" placeholder="RCP" oninput="validateNumberInput(this)">
      <button class="save" onclick="saveSale()">Save</button>
      <button class="delete" id="delete-btn" onclick="deleteSale()" style="display:none;">Delete</button>
    </div>
  </div>  

<div id="reader-wrapper">
  <div id="reader"></div>
  <input type="text" id="manual-ean" placeholder="Enter EAN manually" style="margin-top: 0.75rem; padding: 0.5rem; width: 100%; max-width: 300px; border-radius: 6px; border: 1px solid #ccc;">
  <button id="manual-search" onclick="manualSearch()" style="margin-top: 0.5rem; background-color: #007aff; color: white; border: none; border-radius: 6px; padding: 0.5rem 1rem; cursor: pointer;">Search</button>
  <button id="close-scan" onclick="stopScan()" style="margin-top: 0.5rem; background: #ccc; border-radius: 6px; padding: 0.5rem 1rem; border: none; cursor: pointer;">Close</button>
</div>
<!-- detete Confirm Modal -->
<div class="modal" id="resetModal">
  <div class="modal-content">
    <p style="margin-bottom: 1rem;">Are you sure you want to delete all sales?</p>
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button onclick="proceedReset()" style="background-color:#ff9500; color:white; border:none; border-radius:6px; padding:8px 12px;">Yes</button>
      <button onclick="closeResetModal()" style="background-color:#ccc; border:none; border-radius:6px; padding:8px 12px;">No</button>
    </div>
  </div>
</div>

<div class="modal" id="confirmModal">
  <div class="modal-content">
    <p>Type <b>"confirm"</b> to delete all sales:</p>
    <input type="text" id="confirm-input" placeholder="Type here...">
    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 10px;">
      <button onclick="deleteAllSales()" style="background-color:#ff3b30; color:white; border:none; border-radius:6px; padding:8px 12px;">Delete</button>
      <button onclick="closeConfirmModal()" style="background-color:#ccc; border:none; border-radius:6px; padding:8px 12px;">Cancel</button>
    </div>
  </div>
</div>
<!-- Export Option Modal -->
<div class="modal" id="exportModal">
  <div class="modal-content">
    <p style="margin-bottom: 1rem;">Choose export format or <span onclick="closeExportModal()" style="color: Red; font-weight: bold;">Click here To Cancel</span></p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button onclick="exportToExcel()" style="background-color:#007aff; color:white; border:none; border-radius:6px; padding:8px 12px;">Excel</button>
      <button onclick="exportToPDF()" style="background-color:#ff9500; color:white; border:none; border-radius:6px; padding:8px 12px;">PDF</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="export-toast" style="
  position: fixed;
  top: 40px;
  right: 90px;
  background: var(--toast-dark);
  backdrop-filter: blur(30px);
  color: var(--text-color);
  padding: 12px 20px;
  border-radius: 8px;
  font-size: 14px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.8s ease;
  z-index: 9999;
">
  PDF exported successfully!
</div>

<!-- loading spinning -->
<div id="loading-spinner" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9999;
  backdrop-filter: blur(0px);
  justify-content: center;
  align-items: center;
  font-size: 18px;
  color: white;
  flex-direction: column;
">
  <div class="spinner" style="
    width: 40px;
    height: 40px;
    border: 5px solid #ffffff66;
    border-top-color: #007aff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  "></div>
  <div style="margin-top: 10px;">🌷 Loading Data...</div>
</div>

<footer>
    <!-- <p>====== End of the Report ======</p> -->
    <!-- <h1><i class="fas fa-heart"></i></h1> -->
</footer>


<script>
  firebase.initializeApp({
    apiKey: "AIzaSyCmpkVaoKl1UbXsSiU_ZVP3Tn-xn8yW_xc",
    authDomain: "lead-x-7c1f4.firebaseapp.com",
    projectId: "lead-x-7c1f4",
    storageBucket: "lead-x-7c1f4.firebasestorage.app",
    messagingSenderId: "76689287089",
    appId: "1:76689287089:web:3eda5283a47d8702a87f90"
  });

  const db = firebase.firestore();
  const auth = firebase.auth();

  const user = JSON.parse(localStorage.getItem("user"));
  const userId = user?.uid;
  
  if (user && user.photoURL) {
  const profilePic = document.getElementById("profile-pic");
  if (profilePic) {
    profilePic.src = user.photoURL;
  }
}

  async function saveSale() {
    try {
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const product = document.getElementById("product").value.trim();
      const sale = parseFloat(document.getElementById("sale").value.trim()) || 0;
      const rcp = parseFloat(document.getElementById("rcp").value.trim()) || 0;
      const date = new Date().toISOString().split("T")[0];

      if (!userId) {
        alert("Please log in first.");
        return;
      }

      if (!name || !phone || !product) {
        alert("Please fill all required fields.");
        return;
      }

      if (window.editingSaleId) {
        await db.collection("users").doc(userId).collection("sales").doc(window.editingSaleId).update({
          name, phone, product, sale, rcp, date
        });
        alert("Sale updated.");
        window.editingSaleId = null;
        document.getElementById("delete-btn").style.display = "none";
      } else {
        await db.collection("users").doc(userId).collection("sales").add({
          name, phone, product, sale, rcp, date, timestamp: Date.now()
        });
        alert("Sale saved!");
      }

      clearForm();
      closeModal();
      loadSales();
    } catch (err) {
      console.error("Save failed:", err);
      alert("Failed to save sale: " + err.message);
    }
  }

async function loadSales() {
  if (!userId) return;

  const salesBody = document.getElementById("sales-body");
  salesBody.innerHTML = "";

  const loader = document.getElementById("loading-spinner");
  loader.style.display = "flex"; // Show loading spinner

  try {
    const snapshot = await db
      .collection("users").doc(userId).collection("sales")
      .orderBy("timestamp", "desc")
      .get();

    let total = 0, rcpTotal = 0;

    snapshot.forEach(doc => {
      const sale = doc.data();
      total += Number(sale.sale);
      rcpTotal += Number(sale.rcp);

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${sale.name}</td>
        <td>${sale.phone}</td>
        <td>${sale.product}</td>
        <td>${sale.sale}</td>
        <td>${sale.rcp}</td>
        <td>
          <button onclick="editSale('${doc.id}')" class="editSale"><i class="fa-solid fa-file-pen"></i> &nbsp edit</button>
        </td>
      `;
      salesBody.appendChild(tr);
    });

    animateValue("total-count", 0, snapshot.size);
    animateValue("total-value", 0, total);
    animateValue("rcp-count", 0, rcpTotal);
  } catch (err) {
    console.error("Load failed:", err);
    alert("Failed to load sales: " + err.message);
  } finally {
    loader.style.display = "none"; // Hide loading spinner
  }
}

  function animateValue(id, oldValue, newValue, duration = 1000) {
    oldValue = Number(oldValue);
    newValue = Number(newValue);
    if (oldValue === newValue) return; // Skip animation if no change

    const obj = document.getElementById(id);
    const frameCount = Math.round(duration / 16); // ~60fps
    let frame = 0;

    function update() {
      frame++;
      const progress = frame / frameCount;
      const current = oldValue + (newValue - oldValue) * easeOutQuad(progress);
      obj.textContent = newValue % 1 === 0
        ? Math.round(current)
        : current.toFixed(2);
      if (frame < frameCount) requestAnimationFrame(update);
    }

    requestAnimationFrame(update);
  }

  function easeOutQuad(t) {
    return t * (2 - t);
  }

  function clearForm() {
    ["name", "phone", "product", "sale", "rcp"].forEach(id => {
      document.getElementById(id).value = "";
    });
  }

  function openModal() {
    document.getElementById("saleModal").style.display = "flex";
  }
  
  function CloseModalEnd() {
    document.getElementById("saleModal").style.display = "none";
  }

  function closeModal() {
    document.getElementById("saleModal").style.display = "none";
    window.editingSaleId = null;
    document.getElementById("delete-btn").style.display = "none";
    clearForm();
  }

  function editSale(id) {
    db.collection("users").doc(userId).collection("sales").doc(id).get().then(doc => {
      const sale = doc.data();
      document.getElementById("name").value = sale.name;
      document.getElementById("phone").value = sale.phone;
      document.getElementById("product").value = sale.product;
      document.getElementById("sale").value = sale.sale;
      document.getElementById("rcp").value = sale.rcp;

      window.editingSaleId = id;
      document.getElementById("delete-btn").style.display = "inline-block";
      openModal();
    });
  }

  function deleteSale() {
    if (!window.editingSaleId) return;
    if (!confirm("Are you sure you want to delete this sale?")) return;

    db.collection("users").doc(userId).collection("sales").doc(window.editingSaleId).delete().then(() => {
      alert("Sale deleted.");
      loadSales();
      closeModal();
    });
  }

  window.saveSale = saveSale;
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.editSale = editSale;
  window.deleteSale = deleteSale;
  window.addEventListener("DOMContentLoaded", loadSales);
  
  
  
             // ✅ toggle nav menu
  
  
 
  // Toggle nav menu visibility
  document.getElementById("menu-toggle").addEventListener("click", function () {
    const navMenu = document.getElementById("nav-menu");
    navMenu.style.display = (navMenu.style.display === "none" || navMenu.style.display === "") ? "block" : "none";
  });

  // Optional: Close nav if clicked outside
  document.addEventListener("click", function (event) {
    const navMenu = document.getElementById("nav-menu");
    const menuToggle = document.getElementById("menu-toggle");
    if (!navMenu.contains(event.target) && !menuToggle.contains(event.target)) {
      navMenu.style.display = "none";
    }
  });
  
         
            // ✅ Dark mode Toggle
            
            
            
  // Dark mode toggle logic
  const themeToggleCheckbox = document.getElementById("theme-toggle");

  // Apply stored preference on load
  window.addEventListener("DOMContentLoaded", () => {
    const isDarkMode = localStorage.getItem("darkMode") === "true";
    if (isDarkMode) {
      document.body.classList.add("dark-mode");
      themeToggleCheckbox.checked = true;
    }
  });

  // Toggle dark mode
  themeToggleCheckbox.addEventListener("change", () => {
    if (themeToggleCheckbox.checked) {
      document.body.classList.add("dark-mode");
      localStorage.setItem("darkMode", "true");
    } else {
      document.body.classList.remove("dark-mode");
      localStorage.setItem("darkMode", "false");
    }
  });
  
  
            // ✅ Open export modal
            
            
            
  function openExportModal() {
    document.getElementById("exportModal").style.display = "flex";
  }

  // Close Export Modal
  function closeExportModal() {
    document.getElementById("exportModal").style.display = "none";
  }



            // ✅ reset data function 




  // Open confirmation modal
  function confirmResetSales() {
    document.getElementById("resetModal").style.display = "flex";
  }

  // Close reset confirmation modal
  function closeResetModal() {
    document.getElementById("resetModal").style.display = "none";
  }

  // Proceed to show "Type confirm" modal
  function proceedReset() {
    closeResetModal();
    document.getElementById("confirmModal").style.display = "flex";
  }

  // Close second confirm modal
  function closeConfirmModal() {
    document.getElementById("confirmModal").style.display = "none";
  }

  // Delete all sales if confirmed
  async function deleteAllSales() {
    const input = document.getElementById("confirm-input").value.trim().toLowerCase();
    if (input !== "confirm") {
      alert('Type "confirm" to proceed.');
      return;
    }

    if (!userId) {
      alert("User not logged in.");
      return;
    }

    try {
      const snapshot = await db.collection("users").doc(userId).collection("sales").get();
      const batch = db.batch();

      snapshot.forEach((doc) => {
        batch.delete(doc.ref);
      });

      await batch.commit();
      alert("All sales deleted.");
      document.getElementById("confirmModal").style.display = "none";
      loadSales();
    } catch (err) {
      alert("Failed to delete sales: " + err.message);
    }
  }
 
 
 
       // ✅ export to excel
       
       
       

  async function exportToExcel() {
    closeExportModal();

    if (!userId) {
      alert("Please log in first.");
      return;
    }

    try {
      const snapshot = await db
        .collection("users").doc(userId).collection("sales")
        .orderBy("timestamp", "desc")
        .get();

      const sales = [];
      snapshot.forEach(doc => sales.push(doc.data()));

      if (sales.length === 0) {
        alert("No sales data found to export.");
        return;
      }

      const wb = XLSX.utils.book_new();
      const totalSale = sales.reduce((sum, s) => sum + Number(s.sale || 0), 0);
      const totalRCP = sales.reduce((sum, s) => sum + Number(s.rcp || 0), 0);

      const ws_data = [
        ["Name", "Phone", "Product", "Sale", "RCP", "Date"],
        ...sales.map(s => [
          s.name, s.phone, s.product, s.sale, s.rcp, s.date || ""
        ]),
      ];

      // Add Total row
      const totalRow = [["", "", "Total", totalSale, totalRCP, ""]];
      XLSX.utils.sheet_add_aoa(XLSX.utils.aoa_to_sheet([]), totalRow, { origin: -1 });

      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      XLSX.utils.sheet_add_aoa(ws, totalRow, { origin: -1 });

      XLSX.utils.book_append_sheet(wb, ws, "Sales");
      XLSX.writeFile(wb, "sales_export.xlsx");
    } catch (err) {
      alert("Failed to export: " + err.message);
    }
  }



        // ✅ Export to PDF function 
        
        
        
        
 
  async function exportToPDF() {
    closeExportModal();

    if (!userId || !user) {
      alert("Please log in first.");
      return;
    }

    try {
      const snapshot = await db
        .collection("users").doc(userId).collection("sales")
        .orderBy("timestamp", "desc")
        .get();

      const sales = [];
      snapshot.forEach(doc => sales.push(doc.data()));

      if (sales.length === 0) {
        alert("No sales data found to export.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

      const marginPt = 21.6;
      const now = new Date();

      const pad = n => String(n).padStart(2, '0');
      const dateStr = `${pad(now.getDate())}/${pad(now.getMonth() + 1)}/${now.getFullYear()}`;
      const timeStr = `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
      const fileName = `SALE_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}.pdf`;

      // User Info
      const userName = user.displayName || "N/A";
      const userEmail = user.email || "N/A";

      doc.setFontSize(16);
      doc.text("SALE REPORT", marginPt, marginPt);
      doc.setFontSize(10);
      doc.text(`DATE : ${dateStr}`, marginPt, marginPt + 14);
      doc.text(`TIME : ${timeStr}`, marginPt, marginPt + 28);
      doc.text(`USER : ${userName}`, marginPt, marginPt + 42);
      doc.text(`EMAIL: ${userEmail}`, marginPt, marginPt + 56);

      const sorted = [...sales].sort((a, b) => new Date(b.date) - new Date(a.date));
      const rows = sorted.map(s => [
        s.name || "",
        s.phone || "",
        s.product || "",
        s.sale || "",
        s.rcp || "",
        s.date || ""
      ]);

      const totalSale = sorted.reduce((sum, s) => sum + Number(s.sale || 0), 0);
      const totalRcp = sorted.reduce((sum, s) => sum + Number(s.rcp || 0), 0);
      const totalRow = ["", "", "Total", totalSale, totalRcp, ""];

      doc.autoTable({
        startY: marginPt + 70,
        head: [["Name", "Phone", "Product", "Sale", "RCP", "Date"]],
        body: [...rows, totalRow],
        margin: { left: marginPt, right: marginPt },
        styles: {
          fontSize: 9,
          cellPadding: 2
        },
        headStyles: {
          fillColor: [0, 122, 255],
          textColor: 255,
          fontStyle: 'bold'
        },
        didParseCell: function (data) {
          if (data.row.index === rows.length) {
            data.cell.styles.fontStyle = 'bold';
          }
        },
        didDrawPage: function (data) {
          const pageCount = doc.internal.getNumberOfPages();
          const pageCurrent = doc.internal.getCurrentPageInfo().pageNumber;
          const footerText = `Page ${pageCurrent} of ${pageCount}`;
          doc.setFontSize(9);
          doc.text(footerText, doc.internal.pageSize.getWidth() - marginPt, doc.internal.pageSize.getHeight() - 10, { align: "right" });
        },
        theme: 'grid',
        alternateRowStyles: { fillColor: [245, 245, 245] }
      });

      doc.save(fileName);
      showExportToast();
    } catch (err) {
      alert("Export failed: " + err.message);
    }
  }

  
  function showExportToast() {
    const toast = document.getElementById("export-toast");
    toast.textContent = "PDF exported successfully!";
    toast.style.opacity = 1;
    setTimeout(() => {
      toast.style.opacity = 0;
    }, 3000);
  }
  
  
  
        // ✅ Scan Barcode Function 
  
  
  
  let html5QrCode;
  function startScan() {
  document.getElementById("reader-wrapper").style.display = "flex";
  html5QrCode = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    if (!devices || devices.length === 0) {
      alert("No cameras found.");
      return;
    }

    // ✅ Try to find back/rear camera by name
    const rearCam = devices.find(d => /back|rear|environment/i.test(d.label.toLowerCase()));
    const cameraId = rearCam ? rearCam.id : devices[devices.length - 1].id;

    html5QrCode.start(
      cameraId,
      { fps: 10, qrbox: 250 },
      async (ean) => {
        stopScan(); // Stop after first scan
        await fetchProductFromCSV(ean);
      },
      (error) => {
        // Scan error ignored silently
      }
    ).catch(err => {
      alert("Unable to start camera: " + err);
      stopScan();
    });
  }).catch(err => {
    alert("Error accessing cameras: " + err);
    stopScan();
  });
}

  function stopScan() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
      });
    }
    document.getElementById("reader-wrapper").style.display = "none";
  }

  async function fetchProductFromCSV(ean) {
    try {
      const response = await fetch("https://docs.google.com/spreadsheets/d/1Es0SEOINmzGHBhoAcuVt9CD2s5Zc8DZz/export?format=csv");
      const csv = await response.text();

      const rows = csv.split("\n").map(r => r.split(","));
      const headers = rows[0];
      const eanIndex = headers.findIndex(h => /ean/i.test(h));
      const descIndex = headers.findIndex(h => /material\s*description/i.test(h));

      if (eanIndex === -1 || descIndex === -1) {
        alert("CSV is missing required columns.");
        return;
      }

      const match = rows.find((r, i) => i > 0 && r[eanIndex].trim() === ean.trim());
      if (match) {
        const description = match[descIndex];
        document.getElementById("product").value = description;
        showExportToast("Product found: " + description);
      } else {
        alert("Product not found for EAN: " + ean);
      }
    } catch (err) {
      alert("Failed to fetch product info: " + err.message);
    }
  }

  function manualSearch() {
    const manualEAN = document.getElementById("manual-ean").value.trim();
    if (manualEAN) {
      fetchProductFromCSV(manualEAN);
      stopScan();
    }
  }


            // ✅ search function
            
            

  function filterSales() {
    const input = document.getElementById("search-input").value.toLowerCase();
    const rows = document.querySelectorAll("#sales-body tr");

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(input) ? "" : "none";
    });
  }
  
  
  // ✅ number validate 
  


  function validateNumberInput(el, maxLength) {
    // Remove all non-digit characters
    el.value = el.value.replace(/\D/g, '');

    // Limit to maxLength characters
    if (el.value.length > maxLength) {
      el.value = el.value.slice(0, maxLength);
    }
  }
  
</script>
</body>
  </html> 
